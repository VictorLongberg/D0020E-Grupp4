<!doctype html>
<html>
<head>
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/main.css">
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<script src="/socket.io/socket.io.js"></script>
	<script>
		var socket = io();
		
		function setName() {
			name = prompt("Change nickname: ");
			while (name == "null" || !name || name.length > 30) {
				name = prompt("Please enter valid nickname (MAX 30 CHARACTERS) : ");
			}
			
			//Sanitizing
			var element = document.createElement('div');
			element.innerText = name;
			name = element.innerHTML;
			
			socket.emit('name', name);
			updateChatAs();
		}
		
		function getName() {
			return name;
		}

		function create_group() {
			var gname = prompt("Group name: ");
			socket.emit('createGroup', gname);
		}

	</script>

	<title>Simple chat</title>
	<link rel="icon" type="image/png" href="/images/favicon.png" />

</head>

<body>
	<!-- Memes? -->
	<script  type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
	<!--<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>-->
	<script>
	$(document).ready(function () {
		// Making 2 variable month and day
		var monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
		var dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]

		// make single object
		var newDate = new Date();
		// make current time
		newDate.setDate(newDate.getDate());
		// setting date and time
		$('#Date').html(dayNames[newDate.getDay()] + " " + newDate.getDate() + ' ' + monthNames[newDate.getMonth()] + ' ' + newDate.getFullYear());

		setInterval(function () {
			// Create a newDate() object and extract the seconds of the current time on the visitor's
			var seconds = new Date().getSeconds();
			// Add a leading zero to seconds value
			$("#sec").html((seconds < 10 ? "0" : "") + seconds);
		}, 1000);

		setInterval(function () {
			// Create a newDate() object and extract the minutes of the current time on the visitor's
			var minutes = new Date().getMinutes();
			// Add a leading zero to the minutes value
			$("#min").html((minutes < 10 ? "0" : "") + minutes);
		}, 1000);

		setInterval(function () {
			// Create a newDate() object and extract the hours of the current time on the visitor's
			var hours = new Date().getHours();
			// Add a leading zero to the hours value
			$("#hours").html((hours < 10 ? "0" : "") + hours);
		}, 1000);
	});
	</script>
	<div class="container">
		<div class="clock">
			<div id="Date"></div>
			<ul>
				<li id="hours"></li>
				<li id="point">:</li>
				<li id="min"></li>
				<li id="point">:</li>
				<li id="sec"></li>
			</ul>
		</div>
		<!-- Memes? -->

		<div class="row">

			<div class="col-6">
				<img src="/images/placeholder.jpg" class="img-fluid">
			</div>
			<div class="col-6">
				<div class="messages overflow-auto">
					<ul id="messages"></ul>
				</div>

				<form action="">  <!--Tillåter skapandet av meddelanden att vissas på chatten?!?-->
					<div class="d-flex">
						<div class="dropdown">
							<button class="btn btn-secondary dropdown-toggle btn-sm" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								Reactions
							</button>
							<div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
								<a disabled class="dropdown-item" href="#" id="confusedPic">
									<img src="/images/confused.png" class="reactionIcon">
									Confused - <span id="confusedCount">0</span>
								</a>
								<a disabled class="dropdown-item" href="#">
									<img src="/images/confused.png" class="reactionIcon">
									Yes - <span id="yesCount">0</span>
								</a>
								<a disabled class="dropdown-item" href="#">
									<img src="/images/confused.png" class="reactionIcon">
									No - <span id="noCount">0</span>
								</a>
							</div>
						</div>

						<div class="form-check form-switch ms-1">
							<button disabled type="button" class="btn btn-secondary btn-sm">
								<label class="form-check-label" for="questionCheck">
									Question
								</label>
							</button>
							<input disabled class="form-check-input" type="checkbox" id="questionCheck" onclick="updateChatAs()" />
						</div>

						<div class="form-check form-switch ms-1">
							<button disabled type="button" class="btn btn-secondary btn-sm">
								<label class="form-check-label" for="anonCheck">
									Anonymous
								</label>
							</button>
							<input disabled class="form-check-input" type="checkbox" id="anonCheck" onclick="updateChatAs()" />
						</div>
						<button type="button" class="btn btn-secondary btn-sm ms-1 mb-3" onclick="setName()">
							Change name
						</button>
					</div>
					
					<div class="CurrentUser float-left" id="currentName">
						Chatting as:
						<label>
							<input type="user" id="currentUser" />
						</label>
					</div>
					
					<div class="input-group mb-3 order-1">
						<input type="text" class="form-control" id="m" aria-label="Recipient's username" aria-describedby="button-addon2" autocomplete="off" />
						<div class="input-group-append">
							<button class="btn btn-secondary" id="button-addon2">
								Send
							</button>
						</div>
					</div>
				</div>
			</div>
			
			<button type="button" class="btn btn-secondary btn-sm ms-1 mb-3" onclick="createQueue()">
				Create queue
			</button>
			
			<div class="col-3">
			Queues:
				<ul id="queues">
					<li style="display: block; background-color: rgb(3,32,64); color: white; text-align: center; padding: 16px; text-decoration: none;">
					test1
					</li>
					
					<li style="display: block; background-color: rgb(3,32,64); color: white; text-align: center; padding: 16px; text-decoration: none;">
					test2
					</li>
					
					<li style="display: block; background-color: rgb(3,32,64); color: white; text-align: center; padding: 16px; text-decoration: none;">
					test3
					</li>
				</ul>
			</div>
			<button type="button" class="btn btn-secondary btn-sm ms-1 mb-3" onclick="create_group()">
				Create group
			</button>
			
			<script>
			// --- Queues ---
			function pickFirst(qName) {
				socket.emit('get_first_queue', (qName));
			}
			
			function createQueue() {
				qName = prompt("Queue name?");
				
				if (qName == "null" || !qName || qName.length > 30) {
					alert("Invalid name");
					return;
				}
				
				socket.emit('createQueue', (qName));
			}
			
			function removeQueue(qName) {
				if (confirm("Remove queue " +qName +"?")) {
					socket.emit('removeQueue', (qName));
				}
			}
			
			function updateQueues() {
				socket.emit('updateQueues');
			}
			updateQueues();
			
			socket.on('updateQueues', function(queues) {
				// Clear queues tab
				var queueLength = document.getElementById("queues").children.length;
				for (i = 0; i < queueLength; i++) {
					document.getElementById("queues").children[0].remove();
				}
				
				// Spawn new queues
				for (i = 0; i < queues.length; i++) {
					var jsonQueue = JSON.parse(queues[i]);
					var queueHTML = "<b>" + jsonQueue.qname +"</b>"
					
					// Number of people in queue
					+ "<br> In queue: " + jsonQueue.rarr.length;
					
					// People in queue + message
					for (j = 0; j < jsonQueue.rarr.length; j++) {
						queueHTML += "<br> Student #" + j + ": " + jsonQueue.rarr[j].name + ": " + jsonQueue.rarr[j].message;
					}
					
					// Pick first in queue button
					queueHTML += "<br> <input type='button' onclick='pickFirst(\"" +jsonQueue.qname +"\")' value='Pick first in queue' />"
					
					// Remove queue button
					+ "<br> <input type='button' onclick='removeQueue(\"" +jsonQueue.qname +"\")' value='Remove queue' />";
					var queueElement = $('<li>').html(queueHTML);
					
					// placeholder CSS
					queueElement.css({"display":"block", "background-color":"rgb(3,32,64)", "color":"white", "text-align":"center", "margin":"3px", "padding":"16px", "text-decoration":"none"});
					
					$("#queues").append(queueElement);
				}
			});
			
			// --- Reactions ---
			var confuseBool = false;

			function toggleConfused() {
				if (!confuseBool) {
					confuseBool = true;
					$("#confusedPic").fadeTo(300, 0.2);
					$('#messages').append($('<li>').text("You are confused!"));
					socket.emit('reactConfused');
				}

				else {
					confuseBool = false;
					$('#messages').append($('<li>').text("You are no longer confused."));
					document.getElementById("confusedPic").setAttribute("onclick", ""); 
					setTimeout(confuseCoolDownDone, 3050);
					socket.emit('removeConfused');
				}
			}
			
			function confuseCoolDownDone() {
				$("#confusedPic").fadeTo(300, 1);
				document.getElementById("confusedPic").setAttribute("onclick", "toggleConfused()"); 
			}

			function updateChatAs() {
				var chatAsText = "";

				if (document.getElementById('questionCheck').checked) {
					chatAsText += 'Asking question as: ';
				}

				else {
					chatAsText += 'Chatting as: ';
				}

				if (document.getElementById('anonCheck').checked) {
					chatAsText += 'Anonymous';
				}

				else {
					chatAsText += getName();
				}

				document.getElementById('currentName').innerHTML = chatAsText;
			}

			updateChatAs();

			</script>
		</form>
	</div>
	
	<!--<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>-->
	<script src="\js\bootstrap\bootstrap.bundle.js"></script>
	<script>
	$(function () {
		$('form').submit(function (e) {
			e.preventDefault();

			// If message box is empty don't send message
			if (!$('#m').val()) {
				return;
			}

			//Check question
			if (document.getElementById("questionCheck").checked) {

				if (document.getElementById("anonCheck").checked) {
					socket.emit('question', true, $('#m').val());
				}

				else {
					socket.emit('question', false, $('#m').val());
				}
			}

			else {
				if (document.getElementById("anonCheck").checked) {
					socket.emit('chat message', true, $('#m').val());
				}

				else {
					socket.emit('chat message', false, $('#m').val());
				}
			}

			$('#m').val('');
			return false;
		});

		socket.on('chat message', function (sender, msg, date) {
			var dt = new Date(date);
			var hourStamp = dt.getHours();
			var minuteStamp = dt.getMinutes();
			var secondStamp = dt.getSeconds();
			
			if (hourStamp < 10) {
				hourStamp = "0" + hourStamp;
			}
			
			if (minuteStamp < 10) {
				minuteStamp = "0" + minuteStamp;
			}
			
			if (secondStamp < 10) {
				secondStamp = "0" + secondStamp;
			}
				
			var timeStamp = hourStamp + ":" + minuteStamp + ":" + secondStamp;
			
			// Sanitizing
			var element = document.createElement('div');
			element.innerText = msg;
			msg = element.innerHTML;

			$('#messages').append($('<li>').html('<span class="Sender">' + sender + '</span>' + ": " + msg + '<span class="Time">' + timeStamp + '</span>'));
		});

		socket.on('question', function (sender, questionMsg, questionID, date) {
			var dt = new Date(date);
			var hourStamp = dt.getHours();
			var minuteStamp = dt.getMinutes();
			var secondStamp = dt.getSeconds();
			
			if (hourStamp < 10) {
				hourStamp = "0" + hourStamp;
			}
			
			if (minuteStamp < 10) {
				minuteStamp = "0" + minuteStamp;
			}
			
			if (secondStamp < 10) {
				secondStamp = "0" + secondStamp;
			}
			
			var timeStamp = hourStamp + ":" + minuteStamp + ":" + secondStamp;
			
			// Sanitizing
			var element = document.createElement('div');
			element.innerText = questionMsg;
			questionMsg = element.innerHTML;
			
			var question = $('<li>').html( '<span class="Sender">' + sender + '</span>'  + ": " + questionMsg
			
			// Timestamp
			+ '<span class="Time">'  + timeStamp + '</span>'
			
			// Upvote and answer button after question
			+ '<br> <input id="upvote' + questionID +'" type="button" name="Upvote" value="\u25B2" \>'
			+ '<input id="answer' + questionID +'" type="button" name="Answer" value="\&#10004"\>');
			
			question.css({ "background-color": "rgb(3,32,64)", "font-size": "120%", "color":"white"});
			question.attr({ id: 'question' + questionID });
			$('#messages').append(question);
			
			// Upvote function
			$('#upvote' + questionID).click(function () {
				socket.emit('upvote', questionID);
				$('#upvote' + questionID).remove();
			});
			
			// Answer function
			$('#answer' + questionID).click(function () {
				socket.emit('answer', questionID);
				$('#answer' + questionID).remove();
			});
		});

		socket.on('upvote', function (questionID, memberNum) {
			var fontsize = $('#' + 'question' + questionID).css("font-size");
			newFontsize = fontsize.split("px")[0] * (1 + 1 / memberNum);

			if (newFontsize > 15.6 * 2) {
				newFontsize = 15.6 * 2;
			}

			$('#' + 'question' + questionID).css("font-size", newFontsize);
		});
		
		socket.on('answer', function (questionID) {
			var fontsize = $('#' + 'question' + questionID).css("font-size");
			newFontsize = "120%";
			$('#' + 'question' + questionID).css({"font-size":newFontsize, "background-color":"green"});
			$('#upvote' + questionID).remove();
		});
		
		socket.on('toggleConfuse', function () {
			if (confuseBool) {
				toggleConfused();
			}
		});
		
		socket.on('updateConfused', function(confuseNum) {
			$("#confusedCount").text(confuseNum);
		});


		socket.on('updateQueue', function(json_queue) {
			//console.log("Update queue json:", json_queue);

			// code to update queue from JSON object goes here
			//
			// JSON structure
			//	{
			// 		qname: (queue name)
			// 		rarr: [  <== array of tickets
			//		{ (ticket)
			//			type: (type of entity "Student" or "Group"
			//			name/names: (name(s) of people names if Group)
			//			message: (message of ticket)
			//		}
			//		]
			//	}
		});
	});
	</script>
	<div class="footer">
		<div role="main">
			<a href="https://www.ltu.se/">
				<img src="/images/ltulogga.png" class="align-middle" style="margin-top:5px; margin-bottom:5px; margin-left: 5px; height:65px; width:136px;">
			</a>
		</div>
	</div>

</body>
</html>
